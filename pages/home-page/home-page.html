<!-- Polymer dependencies -->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/google-map/google-map.html">
<link rel="import" href="../../bower_components/google-map/google-map-marker.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../../web-components/project-map-realty-form/project-map-realty-form.html">

<!-- Style dependency -->
<link rel="import" href="home-page-style.html">

<dom-module id="home-page">
  <template>
    <style is="custom-style" include="home-page-style">
      :host {
        display: block;
      }
    </style>

    <firebase-query 
        path="/alpha/prices"
        data="{{prices}}"></firebase-query>

    <google-map
        api-key="AIzaSyB5Mzf2ohRv4rdImrZ5QUA90lS-azxZIvI"
        latitude="14.5958522"
        longitude="121.0301096" 
        zoom="13"
        click-events
        on-google-map-click="_googleMapClick">

        <google-map-marker id="new-pin" latitude="[[newLat]]" longitude="[[newLng]]" on-google-map-marker-close="_closeNewPin" click-events hidden>
          <project-map-realty-form id="new-pin-info" user="[[user]]" latitude="[[newLat]]" longitude="[[newLng]]"></project-map-realty-form>
        </google-map-marker>

        <template is="dom-repeat" items="[[prices]]">
          <google-map-marker id="prices-[[item.$key]]" latitude="[[item.latitude]]" longitude="[[item.longitude]]">
            Price: Php [[item.price]]<br/>
            Contact: [[item.displayName]]<br/>
            Email: <a href="mailto:[[item.email]]">[[item.email]]</a><br/>
            Telephone: <a href="tel:[[item.tel]]">[[item.tel]]</a>
          </google-map-marker>
        </template>

        

        <!--<template is="dom-if" if="[[newPin]]">
          <google-map-marker id="new-pin"></google-map-marker>
          <paper-map-info id="new-pin-info">
            
          </paper-map-info>
        </template>-->

    </google-map>
  </template>

  <script>
    Polymer({
      is: 'home-page',

      properties: {
        user: {
          type: Object
        },

        prices: {
          type: Array
        }
      },

      observers: [
        '_check(prices.splices)'
      ],

      listeners: {
        'close-new-pin': '_closeNewPin'
      },

      _check: function(e) {
        console.log(this.prices)
      },

      ready: function() {
        if (navigator.geolocation) {
          console.log('Geolocation is supported!');
          navigator.geolocation.watchPosition(this._geoSuccess.bind(this), this._geoError.bind(this), {
            enableHighAccuracy: true
          });
        }
        // this.$$('#new-pin').open = false;
      },

      _geoSuccess: function(position) {
        // console.log(position)
        this.$$('google-map').latitude = position.coords.latitude;
        this.$$('google-map').longitude = position.coords.longitude;
      },

      _geoError: function(error) {
        console.log('Error occurred. Error code: ' + error.code);
      },

      _googleMapClick: function(e) {
        if (this.user) {          
          this.newLat = e.detail.latLng.lat();
          this.newLng = e.detail.latLng.lng();
          Polymer.RenderStatus.afterNextRender(this, () => {
            this.$$('#new-pin').hidden = false;
            this.$$('#new-pin').open = true;
          });          
        }
      },

      _closeNewPin: function() {
        this.$$('#new-pin').hidden = true;
        this.$$('#new-pin').open = false;
      },

      // _cancelPrice: function() {
      //   this.newPin = false;
      //   this.$$('#new-pin').hidden = true;
      //   this.$$('#price').value = '';
      //   this.$$('#tel').value = '';
      //   this.submitting = false;
      // },

      _submitPrice: function() {
        this.submitting = true;
        var key = firebase.database().ref('/alpha/prices').push().key;

        if (this.user) {
          firebase.database().ref(`/alpha/prices/${key}`).set({
            uid: this.user.uid,
            email: this.user.email,
            displayName: this.user.displayName,
            price: this.$$('#price').value,
            tel: this.$$('#tel').value,
            longitude: this.$$('#new-pin').longitude,
            latitude: this.$$('#new-pin').latitude
          }).then(() => {
            PROJECTMAP.Elements.Template.$.toast.showMessage('Saved');
            this._cancelPrice();
          });
        }
        
      }
    });
  </script>
</dom-module>
